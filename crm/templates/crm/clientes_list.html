{% extends "rutas/base.html" %}
{% block title %}Clientes{% endblock %}

{% block content %}
<h2>Clientes</h2>

<p>
  <a href="{% url 'crm:crear_cliente' %}" class="btn btn-primary">
    ➕ Crear cliente
  </a>
</p>

<!-- ✅ FILTROS -->
<form method="get" class="filtros">
  <label>
    Segmento:
    <select name="segmento">
      <option value="">Todos</option>
      <option value="VIP" {% if f.segmento == "VIP" %}selected{% endif %}>VIP</option>
      <option value="Frecuente" {% if f.segmento == "Frecuente" %}selected{% endif %}>Frecuente</option>
      <option value="Ocasional" {% if f.segmento == "Ocasional" %}selected{% endif %}>Ocasional</option>
      <option value="Dormido" {% if f.segmento == "Dormido" %}selected{% endif %}>Dormido</option>
    </select>
  </label>

  <label>
    Comuna:
    <select name="comuna">
      <option value="">Todas</option>
      {% for co in comunas %}
        <option value="{{ co }}" {% if f.comuna == co %}selected{% endif %}>{{ co }}</option>
      {% endfor %}
    </select>
  </label>

  <label>
    Mín kilos:
    <input type="number" name="min_kilos" value="{{ f.min_kilos }}" min="0" step="1">
  </label>

  <label>
    Orden:
    <select name="orden">
      <option value="kilos_desc" {% if f.orden == "kilos_desc" or not f.orden %}selected{% endif %}>Más kilos</option>
      <option value="kilos_asc" {% if f.orden == "kilos_asc" %}selected{% endif %}>Menos kilos</option>
      <option value="gasto_desc" {% if f.orden == "gasto_desc" %}selected{% endif %}>Más $</option>
      <option value="gasto_asc" {% if f.orden == "gasto_asc" %}selected{% endif %}>Menos $</option>
      <option value="id" {% if f.orden == "id" %}selected{% endif %}>ID</option>
    </select>
  </label>

  <div class="filtros-actions">
    <button class="btn btn-primary" type="submit">Filtrar</button>
    <a class="btn" href="{% url 'crm:clientes_list' %}">Limpiar</a>
  </div>
</form>

<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Teléfono</th>
        <th>Email</th>
        <th>Comuna</th>
        <th>Dirección</th>
        <th>Kilos comprados</th>
        <th>Total comprado ($)</th>
        <th>Segmento</th>
        <th>Observaciones</th>
        <th>Acciones</th>
      </tr>
    </thead>

    <tbody>
    {% for c in clientes %}
      <tr>
        <td>{{ c.id }}</td>
        <td>{{ c.nombre }}</td>
        <td>{{ c.telefono }}</td>

        <td>
          {% if c.email %}
            <span title="{{ c.email }}">
              {{ c.email|truncatechars:18 }}
            </span>
          {% else %}
            —
          {% endif %}
        </td>

        <td>{{ c.comuna }}</td>
        <td>{{ c.direccion }}</td>

        <td>{{ c.kilos_acumulados|default:0|floatformat:2 }} kg</td>
        <td>$ {{ c.gasto_total|default:0|floatformat:0 }}</td>

        <td>
          <span class="flag flag-{{ c.segmento_color }}">
            {{ c.segmento }}
          </span>
        </td>

        <td>
          {{ c.observaciones|default:"—"|truncatechars:40 }}
        </td>

        <td>
          <div class="acciones">
            <a href="{% url 'crm:editar_cliente' c.id %}"
               class="btn btn-edit">
               Editar
            </a>

            <form method="post"
                  action="{% url 'crm:borrar_cliente' c.id %}"
                  class="inline-form">
              {% csrf_token %}
              <button type="submit"
                      class="btn btn-delete"
                      onclick="return confirm('¿Seguro que quieres borrar este cliente?');">
                Borrar
              </button>
            </form>
          </div>
        </td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="11">No hay clientes.</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
