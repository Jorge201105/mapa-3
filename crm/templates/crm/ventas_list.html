{% extends "rutas/base.html" %}
{% block title %}Ventas{% endblock %}

{% block content %}
<h2>Ventas</h2>

<p>
  <a class="btn btn-primary" href="{% url 'crm:venta_nueva' %}">
    ‚ûï Nueva venta
  </a>
</p>

<!-- üîé FILTROS -->
<form method="get"
      class="filters"
      style="margin-bottom:12px; display:flex; flex-wrap:wrap; gap:8px; align-items:center;">

  <!-- ‚¨ÜÔ∏è‚¨áÔ∏è ORDEN ID -->
  <label>ID:</label>
  <select name="orden_id">
    <option value="desc"
            {% if f.orden_id == "desc" or not f.orden_id %}selected{% endif %}>
      M√°s nuevo
    </option>
    <option value="asc"
            {% if f.orden_id == "asc" %}selected{% endif %}>
      M√°s antiguo
    </option>
  </select>

  <!-- üìÑ Documento -->
  <label>Documento:</label>
  <select name="tipo_documento">
    <option value="">Todos</option>

    <option value="boleta"
            {% if f.tipo_documento == "boleta" %}selected{% endif %}>
      Boleta
    </option>

    <option value="factura"
            {% if f.tipo_documento == "factura" %}selected{% endif %}>
      Factura
    </option>

    <option value="nota_credito"
            {% if f.tipo_documento == "nota_credito" %}selected{% endif %}>
      Nota cr√©dito
    </option>

    <option value="sin_doc"
            {% if f.tipo_documento == "sin_doc" %}selected{% endif %}>
      Sin documento
    </option>
  </select>

  <!-- üì≤ Canal -->
  <label>Canal:</label>
  <select name="canal">
    <option value="">Todos</option>
    <option value="instagram" {% if f.canal == "instagram" %}selected{% endif %}>Instagram</option>
    <option value="whatsapp"  {% if f.canal == "whatsapp" %}selected{% endif %}>WhatsApp</option>
    <option value="web"       {% if f.canal == "web" %}selected{% endif %}>Web</option>
    <option value="otro"      {% if f.canal == "otro" %}selected{% endif %}>Otro</option>
  </select>

  <!-- ‚öñÔ∏è Kilos -->
  <label>Kilos:</label>
  <input type="number"
         step="0.01"
         name="min_kilos"
         placeholder="Min"
         value="{{ f.min_kilos }}"
         style="width:80px;">

  <input type="number"
         step="0.01"
         name="max_kilos"
         placeholder="Max"
         value="{{ f.max_kilos }}"
         style="width:80px;">

  <!-- üîò Botones -->
  <button type="submit" class="btn btn-primary">
    Filtrar
  </button>

  <a href="{% url 'crm:ventas_list' %}" class="btn btn-secondary">
    Limpiar
  </a>
</form>

<!-- üëá WRAPPER PARA SCROLL HORIZONTAL -->
<div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>Cliente</th>
        <th>Fecha</th>
        <th>Documento</th>
        <th>Kilos</th>
        <th>Total ($)</th>   {# ‚úÖ NUEVO #}
        <th>Canal</th>
        <th>Observaciones</th>
        <th>Acciones</th>
      </tr>
    </thead>

    <tbody>
    {% for v in ventas %}
      <tr>
        <td>{{ v.id }}</td>
        <td>{{ v.cliente }}</td>
        <td>{{ v.fecha|date:"d-m-Y H:i" }}</td>

        <!-- üìÑ BOLETA / FACTURA / SIN DOC -->
        <td>
          {% if v.tipo_documento != "sin_doc" %}
            {{ v.get_tipo_documento_display }}
            {% if v.numero_documento %}
              {{ v.numero_documento }}
            {% else %}
              ‚Äî
            {% endif %}
          {% else %}
            ‚Äî
          {% endif %}
        </td>

        <!-- ‚öñÔ∏è Kilos (antes era v.total) -->
        <td>{{ v.kilos_total|floatformat:0 }}</td>

        <!-- üí∞ Pesos -->
        <td>$ {{ v.monto_total|floatformat:0 }}</td>

        <td>{{ v.get_canal_display }}</td>

        <td>
          {{ v.observaciones|default:"‚Äî"|truncatechars:40 }}
        </td>

        <td>
          <div class="acciones">

            <!-- ‚úÖ NUEVO: bot√≥n √çtems -->
            <a class="btn btn-secondary"
              href="{% url 'crm:venta_detalle' v.id %}">
              √çtems
            </a>

            <a class="btn btn-edit"
              href="{% url 'crm:venta_editar' v.id %}">
              Editar
            </a>

            <form method="post"
                  action="{% url 'crm:venta_borrar' v.id %}"
                  class="inline-form">
              {% csrf_token %}
              <button type="submit"
                      class="btn btn-delete"
                      onclick="return confirm('¬øSeguro que quieres borrar esta venta?');">
                Borrar
              </button>
            </form>
          </div>
        </td>


      </tr>
    {% empty %}
      <tr>
        <td colspan="9">No hay ventas.</td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
